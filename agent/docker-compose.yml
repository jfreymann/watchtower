version: "3.9"

services:
  # Watchtower Agent - SSH Login Monitor
  agent:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: watchtower-agent
    restart: unless-stopped
    network_mode: host
    volumes:
      # Mount journald for log access (read-only)
      - /var/log/journal:/var/log/journal:ro
      - /run/systemd/journal:/run/systemd/journal:ro
      # Mount code as read-only
      - ./watchtower_agent.py:/app/watchtower_agent.py:ro
    environment:
      # Collector configuration
      WATCHTOWER_COLLECTOR_URL: ${WATCHTOWER_COLLECTOR_URL:-https://watchtower.local/login}
      WATCHTOWER_TOKEN: ${WATCHTOWER_TOKEN:-changeme-agent-token}

      # Optional metadata
      WATCHTOWER_REGION: ${WATCHTOWER_REGION:-}
      WATCHTOWER_HOST_GROUP: ${WATCHTOWER_HOST_GROUP:-}
      WATCHTOWER_SEVERITY: ${WATCHTOWER_SEVERITY:-info}
      WATCHTOWER_FLAGGED: ${WATCHTOWER_FLAGGED:-false}

      # TLS verification (set to false for internal CA)
      WATCHTOWER_VERIFY_TLS: ${WATCHTOWER_VERIFY_TLS:-true}

      # SSH service unit to monitor
      WATCHTOWER_SSH_UNIT: ${WATCHTOWER_SSH_UNIT:-ssh.service}

    # Security options (relaxed for journald access)
    security_opt:
      - no-new-privileges:true
    read_only: true
    tmpfs:
      - /tmp:noexec,nosuid,size=32M

    # Resource limits
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M
        reservations:
          cpus: '0.1'
          memory: 32M

    # Health check (verify process is running)
    healthcheck:
      test: ["CMD", "pgrep", "-f", "watchtower_agent.py"]
      interval: 60s
      timeout: 5s
      retries: 3
      start_period: 10s
